<%- include('partials/header', { title: '个人主页 - 英语题库' }) %>

<div class="card">
    <h2 style="margin-bottom: 1.5rem;">个人信息</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="info-item">
            <h4 style="color: #7f8c8d; margin-bottom: 0.5rem;">用户名</h4>
            <p style="font-size: 1.2rem; font-weight: bold;"><%= userStats.username %></p>
        </div>
        
        <div class="info-item">
            <h4 style="color: #7f8c8d; margin-bottom: 0.5rem;">上传题目数</h4>
            <p style="font-size: 1.2rem; font-weight: bold;"><%= userStats.problems_uploaded %></p>
        </div>
        
        <div class="info-item">
            <h4 style="color: #7f8c8d; margin-bottom: 0.5rem;">已解决问题数</h4>
            <p style="font-size: 1.2rem; font-weight: bold;"><%= userStats.problems_solved %></p>
        </div>
        
        <div class="info-item">
            <h4 style="color: #7f8c8d; margin-bottom: 0.5rem;">正确率</h4>
            <p style="font-size: 1.2rem; font-weight: bold;"><%= userStats.correct_rate %>%</p>
        </div>
    </div>
</div>

<div class="card">
    <h2 style="margin-bottom: 1.5rem;">修改密码</h2>
    <form action="/change-password" method="POST">
        <div class="form-group">
            <label class="form-label">当前密码</label>
            <input type="password" name="currentPassword" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label class="form-label">新密码</label>
            <input type="password" name="newPassword" class="form-control" required>
        </div>
        
        <div class="form-group">
            <label class="form-label">确认新密码</label>
            <input type="password" name="confirmPassword" class="form-control" required>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn btn-primary">修改密码</button>
        </div>
    </form>
</div>

<div class="card">
    <h2 style="margin-bottom: 1.5rem;">我发布的题目</h2>
    
    <% if (userProblems.length === 0) { %>
        <p style="text-align: center; color: #7f8c8d; padding: 2rem;">您还没有发布过题目</p>
        <div style="text-align: center;">
            <a href="/create-problem" class="btn btn-primary">发布第一个题目</a>
        </div>
    <% } else { %>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>题目名称</th>
                        <th>题目数量</th>
                        <th>创建时间</th>
                        <th>状态</th>
                        <th>删除原因</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <% userProblems.forEach(problem => { %>
                        <tr class="<%= problem.is_approved === 0 ? 'table-row-deleted' : '' %>">
                            <td>
                                <% if (problem.is_approved === 0) { %>
                                    <span style="color: #999;"><%= problem.title %></span>
                                <% } else { %>
                                    <a href="/problem/<%= problem.id %>"><%= problem.title %></a>
                                <% } %>
                            </td>
                            <td>
                                <%= problem.questionCount %> 题
                            </td>
                            <td>
                                <%= new Date(problem.created_at).toLocaleDateString() %>
                            </td>
                            <td>
                                <% if (problem.is_approved === 0) { %>
                                    <span class="status-badge status-deleted">已删除</span>
                                <% } else { %>
                                    <span class="status-badge status-active">正常</span>
                                <% } %>
                            </td>
                            <td>
                                <% if (problem.is_approved === 0 && problem.delete_reason) { %>
                                    <div class="delete-reason">
                                        <%= problem.delete_reason %>
                                    </div>
                                <% } else if (problem.is_approved === 0) { %>
                                    <span style="color: #999; font-style: italic;">无具体原因</span>
                                <% } else { %>
                                    <span style="color: #999;">-</span>
                                <% } %>
                            </td>
                            <td class="action-buttons">
                                <% if (problem.is_approved === 0) { %>
                                    <form action="/delete-record/<%= problem.id %>" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('确定要永久删除这个记录吗？此操作不可恢复！')">
                                            <i class="fas fa-trash-alt"></i> 删除记录
                                        </button>
                                    </form>
                                <% } else { %>
                                    <form action="/delete-problem/<%= problem.id %>" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('确定要删除这个题目吗？')">
                                            <i class="fas fa-trash"></i> 删除
                                        </button>
                                    </form>
                                <% } %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 1.5rem; padding: 1rem; background-color: #f8f9fa; border-radius: 6px;">
            <h4 style="color: #7f8c8d; margin-bottom: 0.5rem;">说明</h4>
            <ul style="margin: 0; padding-left: 1.5rem; color: #666; font-size: 0.9rem;">
                <li>状态为<span style="color: #e74c3c; font-weight: bold;">"已删除"</span>的题目表示已被管理员删除</li>
                <li>您可以查看删除原因，并选择永久删除记录</li>
                <li>永久删除记录将从系统中完全移除，不可恢复</li>
                <li>状态为<span style="color: #2ecc71; font-weight: bold;">"正常"</span>的题目可以正常访问和删除</li>
            </ul>
        </div>
    <% } %>
</div>

<%- include('partials/footer') %>